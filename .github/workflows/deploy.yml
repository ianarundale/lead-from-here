name: Deploy to AWS Serverless (SST)

on:
  push:
    branches: ['main', 'serverless']
    paths:
      - 'client/**'
      - 'lambda/**'
      - 'scenarios.json'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/**'
      - 'sst.config.ts'
      - 'infrastructure/**'
  workflow_dispatch:

env:
  AWS_REGION: eu-west-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set branch name for SST stage
        run: |
          BRANCH_NAME=$(echo '${{ github.ref_name }}' \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's|/|-|g' \
            | sed 's|[^a-z0-9-]|-|g')
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "ROLE_SESSION_NAME=github-oidc-${BRANCH_NAME:0:48}" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            client/package-lock.json

      - name: Install root dependencies
        run: npm install --no-audit --no-fund

      - name: Install client dependencies
        run: cd client && npm install --no-audit --no-fund

      - name: Lint React app
        working-directory: ./client
        run: npm run lint

      - name: Test React app
        working-directory: ./client
        run: CI=true npm test -- --passWithNoTests

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: ${{ env.ROLE_SESSION_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install SST providers
        run: npx sst install

      - name: Deploy with SST
        run: npx sst deploy --stage ${{ env.BRANCH_NAME }}

      - name: Display deployment info
        run: |
          echo "=========================================="
          echo "SST deployment complete"
          echo "=========================================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Stage: ${{ env.BRANCH_NAME }}"
          echo "See 'Deploy with SST' step output for URLs"
